# 运输层

- 运输层

  - 运输层为相互通信的应用进程提供逻辑通信
  - 端口与套接字的意义
  - 无连接的UDP特点
  - 面向连接的TCP特点
  - 再不可靠的网络上实现可靠传输的原理，停止等待协议和ARQ协议
  - TCP的滑动窗口、流量控制、拥塞控制和连接管理

- 一些概念复读

  - 从运输层的角度看，通信的真正端点并不是主机而是主机种的进程

  - 运输层很重要的功能，复用和分用

    - 复用：发送方不同的应用进程都可以使用同一个运输层协议传送数据
    - 分用：接收方的运输层在剥去报文首部后能够把这些数据正确交付目的进程
    
  - 网络层是为主机之间提供逻辑通信，而运输层为应用进程之间提供端到端的逻辑通信
  
  - 为了使不同操作系统的计算机应用进程能够互相通信，不能把特定进程指明为网上通信最后的终点；使用端口号；
  
- TCP

  - 滑动窗口
  - 流量控制
  - 拥塞控制机制
  - 连接管理

- UDP

  - 特点
    - 无连接
    - 尽最大努力交付
    - 面向报文
    - 没有拥塞控制
      - UDP有可能引起网络产生严重的拥塞问题
    - 支持一对一，一对多，多对一和多对多的交互通信
    - 首部开销小，只有8个字节，tcp需要20个字节
  - 首部格式
    - 数据字段
    - 首部字段；8个字节，4个字段，每个字段长度2个字节
      - 源端口；需要回信时选用，不需要时全0
      - 目的端口
      - 长度；UDP数据报的长度，最小值为8（仅有首部）
      - 检验和；检测数据报在传输中是否有错，有错就丢弃
        - 把首部和数据部分一起检验；（IP数据报的检验和只检验IP数据报的首部）
        - 发送方：
          - 先把全零放入 **检验和** 字段
          - 再把伪首部以及UDP用户数据报看成是由许多16位的字符串连接起来
          - 如果数据报部分不是偶数个字节，需要填入一个全零字节（但此字节不发送）
    - 伪首部
      - 计算检验和时，要在UDP数据报之前增加12个字节的伪首部；只在计算检验和时临时添加在UDP数据报前面，得到一个临时的UDP数据报。检验和就是按照这个临时的数据报来计算的；

- TCP

  - 协议

    - 特点
      - 面向连接的运输层协议
      - 每一条TCP连接只能有两个端点
      - 可靠交付（无差错、不丢失、不重复、按序到达）
      - 全双工通信
      - 面向字节流（TCP中的“流”(stream)指的是流入到进程或从进程流出的字节序列。）

  - 可靠传输的工作原理

    - 停止等待协议（ARQ）：每次发送完一个分组就停止发送，等待对方确认，在收到确认后再发送下一个分组；

    - 流水线传输：发送方可以连续发送多个分组，不必每发完一个分组就停顿下来等待对方的确认

      - 连续ARQ协议

        - 发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置；

        - 接收方一般采用

          累积确认

          的方式；在收到几个分组后，对按序到达的最后一个分组发送确认；

          - 优点：容易实现，即使确认丢失也不必重传
          - 缺点：不能向发送方反映出接收方已经正确收到的所有分组的信息
            - 比如发送了5个分组，第三个分组丢失了，接收方只会对前面两个分组发出确认，发送方需要将后面三个分组进行重发

      - 滑动窗口协议（比较复杂，是TCP协议的精髓所在）

  - TCP报文段格式；20个字节

    - **源端口**和**目标端口** 各占2个字节

    - 序号

       占4个字节

      - tcp连接中传送的字节流中的每一个字节都按顺序编号。
      - 整个要传送的字节流的起始序号必须在连接建立时设置。

    - 确认号

       占4个字节

      - 期望收到对方下一个报文段的第一个数据字节的序号

    - 数据偏移

       占4位（1个字节）

      - 指出TCP报文段的数据起始处距离TCP报文段的起始处有多远；
      - **这个字段实际上指出TCP报文段的首部长度**（由于首部中还有长度不确定的选项字段，因此数据偏移字段是必要的）

    - 保留

       占6位

      - 保留为今后使用，目前应置为0

    - \-

      - 紧急URG(URGent)
        - 当URG=1时，表明紧急指针字段有效
        - 告诉系统此报文段中有紧急数据，应尽快传达（相当于高优先级的数据），而不要按照原来的排队顺序传送
      - 确认ACK(ACKnownlegment)
        - 仅当ACK=1时确认号字段才有效；
        - TCP规定，在建立连接后所有传送的报文段都必须把ACK置1；
      - 推送PSH(PuSH)
        - 在一段的应用进程希望在键入一个命令后立即就能收到对方的响应
        - 发送方把TCP的PSH置为1，创建一个报文发送出去，接收方收到PSH=1的报文段，就尽快地交付接收应用进程，而不再等到整个缓存都填满后再向上交付
      - 复位RST(ReSeT)
        - 表明TCP连接中出现严重差错，必须释放连接，然后重新建立运输连接
        - RST=1还用来拒绝一个非法的报文段或拒绝打开一个连接
      - 同步SYN(SYNchronization)
        - 在连接建立时用来同步序号
        - 当SYN=1而ACK=0时，表明这是一个连接请求报文段
        - 对方若同意建立连接，则在响应报文段中使SYN=1和ACK=1
      - 终止FIN(FINis, 意思时“完”、“终”)
        - 用来释放一个连接
        - 当FIN=1，表明此报文段的发送方的数据已经发送完毕，并要求释放连接

    - 窗口

       占2个字节

      - 指发送本报文段的一方的**接收窗口（而不是自己的发送窗口）**
      - **窗口字段明确指出了现在允许对方发送的数据量。窗口值是经常在动态变化着。**

    - 检验和

       占2个字节

      - 检验和字段检验的范围包括首部和数据部两部分
      - 和UDP用户数据报一样，在计算检验和时，要在TCP报文段的前面加上12字节的伪首部

    - 紧急指针

       占2个字节

      - 紧急指针仅在URG=1时才有意义，它指出本报文段中紧急数据的字节数
      - 即使窗口为零时也可以发送紧急数据

    - 选项 长度可变，最长可达40字节

      - 当没有使用选项时，TCP的首部长度是20字节

      - TCP最初只规定了一种选项，即最大报文段长度MSS(Maximum Segment Size)

        - MSS是**每一个**TCP报文段中的**数据字段的最大长度**

        - 数据字段加上TCP首部才等于整个的TCP报文段

        - MSS并不是整个TCP报文段的最大长度，而是“

          TCP报文段长度减去TCP首部长度

          ”

          - MSS应尽可能大些，只要在IP层传输时不需要再分片就行
          - 建立连接过程中，双方都把自己能够支持的MSS写入这一字段，以后就按照这个数值传送数据，两个传送方向可以有不同的MSS值；
          - 若主机未填写这一项，则MSS的默认值是536字节长
          - 因此，所有因特网上的主机都应能接受的报文长度是536+20（固定首部长度）=556字节

      - 随着因特网发展陆续增加了几个选项

        - 窗口扩大 （占3个字节）
        - 时间戳 （占10个字节）
          - 用于计算RTT
          - 用于处理TCP序号超过2的32次方的情况，又称为**防止序号绕回**PAWS；（为了使接收方能够把新的报文段和迟到很久的报文段区分开，可以在报文段中加上这种时间戳。）
        - 选择确认

  - TCP可靠传输的实现

    - 滑动窗口
      - 发送窗口大小
      - 接收窗口大小
    - 超时重传时间(RTO RetransmissionTime-Out)的选择
      - 自适应算法
        - 记录一个报文段发出的时间，以及收到相应确认的时间，这两个时间之差就是报文段的往返时间RTT
        - 如何判定此确认报文段是对先前报文段的确认，还是对后来重传的报文段确认？
          1. 在计算加权平均时RTTs时，只要报文段重传了，就不采用其往返时间样本。
        - 如果报文段的时延突然增大了很多，于是重传报文，但根据该算法，不考虑重传报文段的往返时间样本，这样超时重传时间无法更新
          1. 报文段每重传一次，就把超时时间RTO增大一些
             1. 典型做法是取新的重传时间为旧的两倍
    - 选择确认SACK
      - 若受到的报文段无差错，只是未按序号，中间缺少一些序号的数据，那么能否设法只传缺少的数据而不重传已经正确到达接收方的数据？
      - 如果要使用SACK，建立TCP连接时，要在TCP首部的选项中加上“允许SACK”的选项，而双方必须都事先商定好

  - TCP的流量控制

    - 利用滑动窗口实现流量控制
      - 流量控制就是让发送方的发送速率不要太快，要让接收方来得及接收
      - TCP窗口单位是字节，不是报文段
      - A在收到零窗口的报文段后不久，B发送了非零窗口的报文，然而丢失了，A会一致等待非零窗口的通知，而B也会一致等待A发送的数据，造成死锁；
        - TCP为每个连接设有一个**持续计时器**，只要TCP连接的一方收到对方的零窗口通知，就启动持续计时器
        - 若计时器时间到期，就发送一个零窗口探测报文段（仅携带1字节的数据）
        - 如果窗口仍为零，则重新设置计时器
    - 必须考虑传输效率
      - 控制TCP报文段发送时机
        1. TCP维持一个变量，等于最大报文段长度MSS
        2. 由发送方的应用进程指明要求发送报文段，即TCP支持的推送（push）操作
        3. 发送方的计时器期限到了，就把当前已缓存的数据装入报文段（但长度不能超过MSS）发送出去

  - TCP的拥塞控制

    - 拥塞控制的一般原理

  - TCP的运输管理连接